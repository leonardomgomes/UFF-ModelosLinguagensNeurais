<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Gera√ß√£o de Imagem Representativa</title>

    <style>
        body { font-family: Arial; margin: 20px; }
        .box { border: 1px solid #ccc; padding: 15px; margin: 10px 0; border-radius: 10px; }
        img { width: 100%; max-width: 350px; margin: 10px; }
        .clear { clear: both; }
        .grid-emocoes { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; margin-top: 20px; }
        .grupo { border: 1px solid #aaa; border-radius: 10px; padding: 12px; }
        .grupo table td { padding: 4px; white-space: nowrap; }
        .titulo { text-align: center; font-weight: bold; margin-bottom: 8px; padding: 6px; border-radius: 6px; font-size: 1.1rem; }
        .positivo { background-color: #dff5d8; }
        .negativo { background-color: #f4d7d7; }
        .ambiguo  { background-color: #f8e9c5; }
        .neutro   { background-color: #e5e5e5; }
        table { width: 100%; border-collapse: collapse; }
        td { padding: 4px; vertical-align: top; }
        .destacado { background-color: #FFFF6D; border-radius: 4px; padding: 2px 4px; }
        .tabela-dupla { display: grid; grid-template-columns: 1fr 1fr; }
        .disabled-btn { opacity: 0.5; pointer-events: none; }

        /* ===== loading / progress styles ===== */
        #loadingArea {
            display: none;
            padding: 12px;
            border-radius: 8px;
            background: #f7f7f7;
            border: 1px solid #ddd;
            margin: 12px 0;
        }
        .spinner {
            display:inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid #eee;
            border-top-color: #333;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        #progressWrap { display:none; margin-top:12px; }
        #progressBarBg {
            width:100%; background:#eee; height:18px; border-radius:9px; overflow:hidden;
        }
        #progressBar {
            width:0%; height:18px; background:#4CAF50; transition:width 0.2s;
        }

        .result-images { display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
    </style>

    <script>
        function atualizarModoGeracao(modo) {
            const btn = document.getElementById("btnGerarImagens");
            const hiddenAcao = document.querySelector('input[name="modo_acoes_hidden"]');

            if (hiddenAcao) hiddenAcao.value = modo;

            if (modo === "auto") {
                btn.disabled = true;
                btn.classList.add("disabled-btn");

                const form = document.getElementById("formGerarImagens");
                if (form && form.dataset.autoSubmitted !== "true") {
                    form.dataset.autoSubmitted = "true";
                    form.submit();
                }
            } else {
                btn.disabled = false;
                btn.classList.remove("disabled-btn");
            }
        }

        function atualizarModoGeracaoLLM(modo) {
            const hiddenLLM = document.querySelector('input[name="modo_geracao_hidden"]');
            if (hiddenLLM) hiddenLLM.value = modo;
        }

        function validarFormularioProcessar(form) {
            const texto = form.user_text.value.trim();
            if (!texto) {
                alert("Por favor, digite algum texto antes de prosseguir.");
                return false;
            }
            return true;
        }

        // ===== polling / ajax for generation =====
        async function startGenerationAJAX(e) {
            e.preventDefault();

            const btn = document.getElementById("btnGerarImagens");
            btn.disabled = true;
            btn.classList.add("disabled-btn");

            // mostra loading UI
            document.getElementById("loadingArea").style.display = "block";
            document.getElementById("progressWrap").style.display = "block";
            document.getElementById("progressBar").style.width = "0%";
            document.getElementById("loadingText").innerText = "Iniciando gera√ß√£o...";

            const form = document.getElementById("formGerarImagens");
            const formData = new FormData(form);

            // chamamos /gerar_imagens (que iniciar√° background thread)
            try {
                const resp = await fetch(form.action, {
                    method: "POST",
                    body: formData,
                    headers: { "X-Requested-With": "XMLHttpRequest" }
                });

                // se servidor retornou HTML (fallback), ignora e faz polling de qualquer forma
                // iniciamos polling
                pollProgressAndFetchResult();
            } catch (err) {
                console.error("Erro ao iniciar gera√ß√£o:", err);
                document.getElementById("loadingText").innerText = "Erro ao iniciar gera√ß√£o.";
                btn.disabled = false;
                btn.classList.remove("disabled-btn");
            }
        }

        let pollInterval = null;
        async function pollProgressAndFetchResult() {
            const loadingText = document.getElementById("loadingText");
            if (pollInterval) clearInterval(pollInterval);

            pollInterval = setInterval(async () => {
                try {
                    const r = await fetch("/progress");
                    const j = await r.json();

                    const pct = j.progress || 0;
                    document.getElementById("progressBar").style.width = pct + "%";
                    loadingText.innerText = j.in_progress ? `Gerando imagens... ${pct}%` : `Conclu√≠do ${pct}%`;

                    if (!j.in_progress) {
                        clearInterval(pollInterval);
                        // busca resultados finais
                        await fetchGenerationResultAndRender();
                        // esconde loading depois de curto delay
                        setTimeout(() => {
                            document.getElementById("loadingArea").style.display = "none";
                        }, 800);
                        const btn = document.getElementById("btnGerarImagens");
                        btn.disabled = false;
                        btn.classList.remove("disabled-btn");
                    }
                } catch (err) {
                    console.error("Erro polling:", err);
                }
            }, 800);
        }

        async function fetchGenerationResultAndRender() {
            try {
                const r = await fetch("/generation_result");
                const j = await r.json();

                // Render sem LLm
                const semWrap = document.querySelector(".col h2 + *"); // first col content - we'll instead target by container
                // we'll fill specific containers we add below
                const semContainer = document.getElementById("sem_llm_container");
                const comContainer = document.getElementById("com_llm_container");
                const promptBox = document.getElementById("prompt_otimizado_box");

                // limpa
                semContainer.innerHTML = "";
                comContainer.innerHTML = "";
                if (promptBox) promptBox.innerText = "";

                if (j.imagens_sem_llm && j.imagens_sem_llm.length) {
                    const wrap = document.createElement("div");
                    wrap.className = "result-images";
                    j.imagens_sem_llm.forEach((src, idx) => {
                        const img = document.createElement("img");
                        img.src = src;
                        wrap.appendChild(img);
                    });
                    semContainer.appendChild(wrap);

                    // tempos
                    if (j.tempos_sem_llm && j.tempos_sem_llm.length) {
                        const tblock = document.createElement("div");
                        tblock.innerHTML = "<h3>Tempos:</h3>";
                        j.tempos_sem_llm.forEach(t => {
                            const p = document.createElement("p");
                            p.innerText = t + " segundos";
                            tblock.appendChild(p);
                        });
                        semContainer.appendChild(tblock);
                    }
                }

                if (j.prompt_otimizado) {
                    if (!promptBox) {
                        // cria
                        const pdiv = document.createElement("div");
                        pdiv.id = "prompt_otimizado_box";
                        pdiv.className = "box";
                        pdiv.innerHTML = "<h3>Prompt otimizado:</h3>" + j.prompt_otimizado;
                        // tenta inserir antes do bloco 'Com LLM'
                        const comSection = document.querySelector("div.col + div.col");
                        if (comSection) comSection.prepend(pdiv);
                    } else {
                        promptBox.innerText = j.prompt_otimizado;
                    }
                }

                if (j.imagens_com_llm && j.imagens_com_llm.length) {
                    const wrap = document.createElement("div");
                    wrap.className = "result-images";
                    j.imagens_com_llm.forEach((src, idx) => {
                        const img = document.createElement("img");
                        img.src = src;
                        wrap.appendChild(img);
                    });
                    comContainer.appendChild(wrap);

                    // tempos
                    if (j.tempos_com_llm && j.tempos_com_llm.length) {
                        const tblock = document.createElement("div");
                        tblock.innerHTML = "<h3>Tempos:</h3>";
                        j.tempos_com_llm.forEach(t => {
                            const p = document.createElement("p");
                            p.innerText = t + " segundos";
                            tblock.appendChild(p);
                        });
                        comContainer.appendChild(tblock);
                    }
                }

                if (j.erro) {
                    alert("Erro na gera√ß√£o: " + j.erro);
                }
            } catch (err) {
                console.error("Erro ao obter resultados:", err);
            }
        }

        window.onload = function() {
            // Inicializa bot√£o de acordo com modo selecionado
            const modoSelecionado = document.querySelector('input[name="modo_acoes"]:checked')?.value || "manual";
            atualizarModoGeracao(modoSelecionado);

            const modoLLMSelecionado = document.querySelector('input[name="modo_geracao"]:checked')?.value || "ambos";
            atualizarModoGeracaoLLM(modoLLMSelecionado);

            // Adiciona listeners para atualizar hidden inputs dinamicamente
            document.querySelectorAll('input[name="modo_acoes"]').forEach(r => {
                r.addEventListener('change', e => atualizarModoGeracao(e.target.value));
            });
            document.querySelectorAll('input[name="modo_geracao"]').forEach(r => {
                r.addEventListener('change', e => atualizarModoGeracaoLLM(e.target.value));
            });

            // intercepta submit do formGerarImagens para usar AJAX e progress
            const formGen = document.getElementById("formGerarImagens");
            if (formGen) {
                formGen.addEventListener("submit", startGenerationAJAX);
            }

            // se o servidor respondeu com "mostrar_progresso" true no template renderizado (fallback),
            // iniciamos o polling imediatamente
            {% if mostrar_progresso %}
            document.getElementById("loadingArea").style.display = "block";
            document.getElementById("progressWrap").style.display = "block";
            pollProgressAndFetchResult();
            {% endif %}
        };
    </script>
</head>

<body>

<h1>Gera√ß√£o de Imagem Representativa de Texto</h1>

<form action="/processar" method="post" onsubmit="return validarFormularioProcessar(this);">
    <b>Digite o texto:</b><br>
    <textarea name="user_text" rows="4" cols="100">{{ user_text }}</textarea><br><br>

    <!-- BLOCO GERA√á√ÉO DE IMAGENS (AUTO / MANUAL) -->
    <b>Gera√ß√£o de Imagens:</b><br>
    <label>
        <input type="radio" name="modo_acoes" value="manual"
               {% if modo_acoes == "manual" or modo_acoes is not defined %}checked{% endif %}>
        Gerar Imagens clicando no bot√£o
    </label><br>
    <label>
        <input type="radio" name="modo_acoes" value="auto"
               {% if modo_acoes == "auto" %}checked{% endif %}>
        Gerar Imagens automaticamente
    </label><br><br>

    <!-- BLOCO MODO DE GERA√á√ÉO (LLM) -->
    <b>Modo de gera√ß√£o de imagens:</b><br>
    <label><input type="radio" name="modo_geracao" value="ambos"
                  {% if modo_geracao == "ambos" or modo_geracao is not defined %}checked{% endif %}> Ambos</label><br>
    <label><input type="radio" name="modo_geracao" value="sem_llm"
                  {% if modo_geracao == "sem_llm" %}checked{% endif %}> Sem LLM</label><br>
    <label><input type="radio" name="modo_geracao" value="com_llm"
                  {% if modo_geracao == "com_llm" %}checked{% endif %}> Com LLM</label><br><br>

    <button type="submit">Identificar Emo√ß√µes no Texto</button>
</form>

{% if emocoes %}
<hr>

<h2>Emo√ß√µes Detectadas</h2>
{% set categorias = {
    "positivas": {"titulo": "Emo√ß√µes Positivas", "cor": "positivo", "itens": {"admira√ß√£o":"üëã","divers√£o":"üòÇ","aprova√ß√£o":"üëç","carinho":"üòò","desejo":"üòç","empolga√ß√£o":"ü§©","gratid√£o":"üôè","alegria":"üòÉ","amor":"‚ù§Ô∏è","otimismo":"‚úåÔ∏è","orgulho":"‚ò∫Ô∏è","al√≠vio":"üòÖ"}},
    "negativas": {"titulo": "Emo√ß√µes Negativas", "cor": "negativo", "itens": {"raiva":"üò°","irrita√ß√£o":"üò§","decep√ß√£o":"üòû","desaprova√ß√£o":"üëé","nojo":"ü§Æ","constrangimento":"üò≥","medo":"üò∞","pesar":"üò≠","nervosismo":"üò¨","remorso":"üòü","tristeza":"‚òπÔ∏è"}},
    "ambiguas": {"titulo": "Emo√ß√µes Amb√≠guas", "cor": "ambiguo", "itens": {"confus√£o":"üòï","curiosidade":"ü§î","percep√ß√£o":"ü§®","surpresa":"üòÆ"}},
    "neutras": {"titulo": "Emo√ß√µes Neutras", "cor": "neutro", "itens": {"neutro":"üò∂"}}
} %}

<div class="grid-emocoes">
    {% for cat, dados in categorias.items() %}
        {% set lista = dados.itens.items() %}
        {% set duas_colunas = lista|length > 6 %}
        <div class="grupo">
            <div class="titulo {{ dados.cor }}">{{ dados.titulo }}</div>
            <div class="{% if duas_colunas %}tabela-dupla{% endif %}">
                <table>
                {% for emo, emoji in lista %}
                    {% set valor = emocoes.get(emo, 0) %}
                    {% set destaque = valor > 0.5 %}
                    {#{% set destaque2 = valor >= 0.01 %}#}
                    {#{% set destaque2 = (valor * 100)|int > 0 %}#}
                    {% set exibido = "%.2f"|format(valor|float) %}
                    {% set destaque2 = exibido != "0.00" %}
                    <tr>
                        <td class="{% if destaque %}destacado{% endif %}">
                            {{ emoji }} ‚Äî {{ emo }}
                            {#{% if valor > 0 %}: <b>{{ "%.2f"|format(valor) }}</b>{% endif %}#}
                            {#<b>{{ valor }} ({{ valor.__class__.__name__ }})</b>#}
                            {#{% if destaque2 %}‚úî{% endif %}#}
                            {% if destaque2 %}
                                <b>{{ exibido }} ‚úî</b>
                            {% else %}
                                <b>{{ exibido }}<b>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </table>
            </div>
        </div>
    {% endfor %}
</div>

<br>
<hr>

<h2>Texto do Usu√°rio + Emo√ß√µes Identificadas</h2>
<textarea disabled name="user_text_prompt" rows="4" cols="100">{{ texto_completo }}</textarea><br>


<!-- FORM GERAR IMAGENS -->
<form id="formGerarImagens" action="/gerar_imagens" method="post">
    <input type="hidden" name="modo_geracao_hidden" value="{{ modo_geracao }}">
    <input type="hidden" name="modo_acoes_hidden" value="{{ modo_acoes }}">
    <button id="btnGerarImagens"
            class="{% if modo_acoes == 'auto' %}disabled-btn{% endif %}"
            {% if modo_acoes == 'auto' %}disabled{% endif %}>
        Gerar Imagens
    </button>
</form>

<!-- AREA DE LOADING E PROGRESS -->
<div id="loadingArea">
    <span class="spinner"></span>
    <span id="loadingText">Gerando imagens...</span>

    <div id="progressWrap">
        <div id="progressBarBg"><div id="progressBar"></div></div>
    </div>
</div>

<hr>

<div class="col">
    <h2>Sem LLM</h2>
    <div id="sem_llm_container">
        {% if imagens_sem_llm %}
            <div class="result-images">
            {% for img in imagens_sem_llm %}<img src="{{ img }}">{% endfor %}
            </div>
            <h3>Tempos:</h3>
            {% for t in tempos_sem_llm %}<p>{{ t }} segundos</p>{% endfor %}
        {% endif %}
    </div>
</div>

<div class="col">
    <h2>Com LLM</h2>
    <div id="prompt_otimizado_box">
        {% if prompt_otimizado %}<div class="box"><h3>Prompt otimizado:</h3>{{ prompt_otimizado }}</div>{% endif %}
    </div>

    <div id="com_llm_container">
        {% if imagens_com_llm %}
            <div class="result-images">
            {% for img in imagens_com_llm %}<img src="{{ img }}">{% endfor %}
            </div>
            <h3>Tempos:</h3>
            {% for t in tempos_com_llm %}<p>{{ t }} segundos</p>{% endfor %}
        {% endif %}
    </div>
</div>

<div class="clear"></div>
{% endif %}

</body>
</html>
